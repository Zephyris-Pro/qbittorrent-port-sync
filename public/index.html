<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>qBittorrent Port Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <svg
      aria-hidden="true"
      style="position: absolute; width: 0; height: 0; overflow: hidden"
    >
      <symbol id="icon-clipboard" viewBox="0 0 24 24">
        <path
          d="M9 3h6a2 2 0 0 1 2 2h1a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h1a2 2 0 0 1 2-2Zm0 0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </symbol>
      <symbol id="icon-check" viewBox="0 0 24 24">
        <path
          d="M20 6L9 17l-5-5"
          fill="none"
          stroke="currentColor"
          stroke-width="2.2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </symbol>
      <symbol id="icon-refresh" viewBox="0 0 24 24">
        <path
          d="M23 4v6h-6M1 20v-6h6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </symbol>
      <symbol id="icon-sun" viewBox="0 0 24 24">
        <circle
          cx="12"
          cy="12"
          r="4.5"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        />
        <path
          d="M12 2v2M12 20v2M4 12H2M22 12h-2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
        />
      </symbol>
      <symbol id="icon-moon" viewBox="0 0 24 24">
        <path
          d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </symbol>
    </svg>

    <div class="container">
      <button
        class="icon-btn theme-toggle"
        id="themeToggle"
        title="Change theme"
        aria-label="Change theme"
      >
        <svg class="icon is-sun hidden" width="22" height="22">
          <use href="#icon-sun"></use>
        </svg>
        <svg class="icon is-moon hidden" width="22" height="22">
          <use href="#icon-moon"></use>
        </svg>
      </button>

      <h1>qBittorrent Port Sync</h1>
      <div class="port-container">
        <div class="port" id="port">—</div>
        <button class="icon-btn" id="copyBtn" title="Copy port">
          <svg class="icon is-copy" width="22" height="22">
            <use href="#icon-clipboard"></use>
          </svg>
          <svg class="icon is-check hidden" width="22" height="22">
            <use href="#icon-check"></use>
          </svg>
        </button>
      </div>
      <p class="timer">Next update in <span id="countdown">—</span> s</p>
      <p id="copied-msg" class="copied">Port copied ✅</p>

      <button
        class="icon-btn refresh-btn"
        id="refreshBtn"
        title="Force refresh"
        aria-label="Force refresh"
      >
        <svg class="icon" width="22" height="22">
          <use href="#icon-refresh"></use>
        </svg>
      </button>
    </div>

    <script>
      const portElem = document.getElementById("port");
      const countdown = document.getElementById("countdown");
      const copyBtn = document.getElementById("copyBtn");
      const refreshBtn = document.getElementById("refreshBtn");
      const copiedMsg = document.getElementById("copied-msg");
      const iconCopy = copyBtn.querySelector(".is-copy");
      const iconCheck = copyBtn.querySelector(".is-check");

      const themeToggle = document.getElementById("themeToggle");
      const sunIcon = themeToggle.querySelector(".is-sun");
      const moonIcon = themeToggle.querySelector(".is-moon");
      const storageKey = "theme";
      const mqlDark = window.matchMedia("(prefers-color-scheme: dark)");
      let isAuto = false;

      function setTheme(theme, persist) {
        document.documentElement.setAttribute("data-theme", theme);
        if (theme === "dark") {
          sunIcon.classList.remove("hidden");
          moonIcon.classList.add("hidden");
        } else {
          sunIcon.classList.add("hidden");
          moonIcon.classList.remove("hidden");
        }
        if (persist) localStorage.setItem(storageKey, theme);
      }

      function initTheme() {
        const stored = localStorage.getItem(storageKey);
        if (stored === "light" || stored === "dark") {
          isAuto = false;
          setTheme(stored, false);
        } else {
          isAuto = true;
          setTheme(mqlDark.matches ? "dark" : "light", false);
        }
      }

      initTheme();

      mqlDark.addEventListener("change", (e) => {
        if (isAuto) setTheme(e.matches ? "dark" : "light", false);
      });

      themeToggle.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "dark" ? "light" : "dark";
        isAuto = false;
        setTheme(next, true);
      });

      let remaining = 0;

      async function refresh() {
        const res = await fetch("/status");
        const data = await res.json();
        portElem.textContent = data.current_port ?? "—";
        remaining = data.next_update_in;
      }

      async function forceRefresh() {
        try {
          refreshBtn.classList.add("refreshing");

          await fetch("/force-update");

          await refresh();

          copiedMsg.textContent = "Port refreshed ✅";
          copiedMsg.classList.add("visible");

          setTimeout(() => {
            copiedMsg.classList.remove("visible");
            setTimeout(() => {
              copiedMsg.textContent = "Port copied ✅";
            }, 300);
          }, 1500);
        } catch (error) {
          console.error("Failed to force refresh:", error);
        } finally {
          refreshBtn.classList.remove("refreshing");
        }
      }

      setInterval(async () => {
        if (remaining > 0) remaining--;
        else await refresh();
        countdown.textContent = remaining;
      }, 1000);

      copyBtn.addEventListener("click", async () => {
        const text = portElem.textContent.trim();
        if (!text || text === "—") return;
        await navigator.clipboard.writeText(text);
        iconCopy.classList.add("hidden");
        iconCheck.classList.remove("hidden");
        copyBtn.classList.add("success");
        copiedMsg.classList.add("visible");
        setTimeout(() => {
          iconCheck.classList.add("hidden");
          iconCopy.classList.remove("hidden");
          copyBtn.classList.remove("success");
          copiedMsg.classList.remove("visible");
        }, 1200);
      });

      refreshBtn.addEventListener("click", forceRefresh);

      refresh();

      document.head.insertAdjacentHTML(
        "beforeend",
        `<style>
          @keyframes spin {
            100% { transform: rotate(360deg); }
          }
          .refresh-btn.refreshing svg {
            animation: spin 1s linear infinite;
          }
        </style>`
      );
    </script>
  </body>
</html>
